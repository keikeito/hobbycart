version: '3.3'
services:
  #nginx:
  #  image: nginx
  # 本番用のイメージファイル
  prod_ap:
    image: asia.gcr.io/compact-nirvana-140509/hobbycart-production:v5
    ports:
      - "3001:3000"
    depends_on:
      - db
  ap:
    build: .
    volumes:
      - .:/hobbycart
    ports:
      - "3000:3000"
    stdin_open: true
    tty: true
    command: bash -c "(bundle check || bundle install) && bundle exec rails s -b '0.0.0.0'"
    volumes:
      - .:/hobbycart
      #- gems:/usr/local/bundle
    depends_on:
      - db
      - db_test
      #- elasticsearch
      - redis
  redis:
    image: redis
  db_local:
    image: mysql:5.7
    volumes:
      - hobbycart-db-data:/var/lib/mysql
    ports:
      - "4306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: example
      MYSQL_USER: hobbycart
      MYSQL_PASSWORD: hobbycart11
      MYSQL_DATABASE: hobbycart_development
  # GCP cloud sql
  db:
    image: "gcr.io/cloudsql-docker/gce-proxy"
    command:
      ["/cloud_sql_proxy",
       "-instances=compact-nirvana-140509:asia-northeast1:hobbycart=tcp:0.0.0.0:3306",
       "-credential_file=/config/compact-nirvana-140509-11f7bcd62916.json"]
    volumes:
      - "./compact-nirvana-140509-11f7bcd62916.json:/config/compact-nirvana-140509-11f7bcd62916.json"
    ports:
      - "3306:3306"
  db_test:
    image: mysql:5.7
    # restart: always
    volumes:
      - hobbycart-test-db-data:/var/lib/mysql
    ports:
      - "4307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: example
      MYSQL_USER: hobbycart
      MYSQL_PASSWORD: hobbycart11
      MYSQL_DATABASE: hobbycart_test
  adminer:
    image: adminer
    ports:
      - 8080:8080
#  elasticsearch:
#    image: docker.elastic.co/elasticsearch/elasticsearch:6.3.1
#    container_name: elasticsearch
#    environment:
#      - cluster.name=docker-cluster
#      - bootstrap.memory_lock=true
#      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
#    ulimits:
#      memlock:
#        soft: -1
#        hard: -1
#    volumes:
#      - hobbycart-esdata:/usr/share/elasticsearch/data
#    ports:
#      - 9200:9200

volumes:
  hobbycart-db-data:
    driver: local
  hobbycart-test-db-data:
    driver: local
  hobbycart-esdata:
    driver: local
  gems:
    driver: local
